"use strict";(self.webpackChunkACRA_Point_V3_Education=self.webpackChunkACRA_Point_V3_Education||[]).push([[5603],{5593:(r,n,e)=>{e.r(n),e.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>c});var i=e(5893),l=e(1151);const t={},s="libutool.go",a={type:"mdx",permalink:"/ilovedev/wauth/libutool",source:"@site/src/pages/wauth/libutool.md",title:"libutool.go",description:"libutool\uc740 util\ud568\uc218. \ubaa8\ub4e0 Repositories\uc5d0\uc11c \uc0ac\uc6a9\ud568",frontMatter:{},unlisted:!1},o={},c=[{value:"enc.go",id:"encgo",level:3},{value:"file.go",id:"filego",level:3},{value:"error.go",id:"errorgo",level:3},{value:"logging.go",id:"logginggo",level:3}];function d(r){const n={code:"code",h1:"h1",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.a)(),...r.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"libutoolgo",children:"libutool.go"}),"\n",(0,i.jsx)(n.p,{children:"libutool\uc740 util\ud568\uc218. \ubaa8\ub4e0 Repositories\uc5d0\uc11c \uc0ac\uc6a9\ud568"}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.h3,{id:"encgo",children:"enc.go"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\ubaa8\ub4e0 \uc554\ud638\ud654 \ud568\uc218\ub294 \uad6d\uac00\uc6a9 \ubcf4\uc548\uc694\uad6c\uc0ac\ud56d 3\ub97c \ub530\ub984(CC\uc778\uc99d)"}),"\n",(0,i.jsxs)(n.li,{children:["salt \uc0dd\uc131 \ud568\uc218","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"pbkdf2\ub97c \ud638\ucd9c \ud560\ub54c \uc0ac\uc6a9"}),"\n",(0,i.jsx)(n.li,{children:"\ub9ce\uc740 \ub9ac\ub205\uc2a4 \uc7a5\ube44\ub4e4\uc774 shadow\ud30c\uc77c\uc5d0 \ube44\ubc00\ubc88\ud638\ub97c \uc800\uc7a5\ud560\ub54c salt + hashed_password \ud615\uc2dd\uc73c\ub85c \uc800\uc7a5\ud558\uace0 \uc788\uc74c"}),"\n",(0,i.jsxs)(n.li,{children:["Salt()","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func Salt(size int) ([]byte, error) {\r\n\r\n  seed := make([]byte, MaxEntropyBytes)\r\n  _, err := rand.Read(seed)\r\n  if err != nil {\r\n      return []byte{}, ErrorStack(err)\r\n  }\r\n\r\n  rng, err := NewHmacDrbg(256, seed, nil)\r\n  if err != nil {\r\n      return []byte{}, ErrorStack(err)\r\n  }\r\n\r\n  gen := make([]byte, size)\r\n  rd := NewHmacDrbgReader(rng)\r\n  _, err = rd.Read(gen)\r\n  if err != nil {\r\n      return []byte{}, ErrorStack(err)\r\n  }\r\n\r\n  // \uad6d\uac00\uc6a9 \ubcf4\uc548\uc694\uad6c\uc0ac\ud56d V3 : \uba54\ubaa8\ub9ac \ub36e\uc5b4\uc4f0\uae30\r\n  for _, v := range []byte{0, 0, 0, 0, 0} {\r\n      for i := 0; i < len(gen); i++ {\r\n          gen[i] = v\r\n      }\r\n      for i := 0; i < len(seed); i++ {\r\n          seed[i] = v\r\n      }\r\n  }\r\n\r\n  return gen, nil\r\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["AES256 CTR \ubcf5\ud638\ud654 \ud568\uc218","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["DecodeBase64AndAES256CTRDecrypt()","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func DecodeBase64AndAES256CTRDecrypt(key string, data string) ([]byte, error) {\r\n\r\n  // Base64 \ub514\ucf54\ub529\r\n  ciphertext, err := base64.StdEncoding.DecodeString(data)\r\n  if err != nil {\r\n      return []byte{}, err\r\n  }\r\n\r\n  block, err := aes.NewCipher([]byte(key))\r\n  if err != nil {\r\n      return []byte{}, err\r\n  }\r\n\r\n  if len(ciphertext) < aes.BlockSize {\r\n      return []byte{}, ErrorStack(fmt.Errorf("ciphertext too short"), "E_DEFT_0000")\r\n  }\r\n\r\n  // Extract the IV from the ciphertext\r\n  iv := ciphertext[:aes.BlockSize]\r\n  ciphertext = ciphertext[aes.BlockSize:]\r\n\r\n  stream := cipher.NewCTR(block, iv)\r\n\r\n  plaintext := make([]byte, len(ciphertext))\r\n  stream.XORKeyStream(plaintext, ciphertext)\r\n\r\n  // \uad6d\uac00\uc6a9 \ubcf4\uc548\uc694\uad6c\uc0ac\ud56d V3 : \uba54\ubaa8\ub9ac \ub36e\uc5b4\uc4f0\uae30\r\n  for _, v := range []byte{0, 0, 0, 0, 0} {\r\n      for i := 0; i < len(iv); i++ {\r\n          iv[i] = v\r\n      }\r\n      for i := 0; i < len(ciphertext); i++ {\r\n          ciphertext[i] = v\r\n      }\r\n      key = strings.Repeat(fmt.Sprintf("%v", v), len(key))\r\n  }\r\n\r\n  return plaintext, nil\r\n}\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud574\uc2dc\uac12 \uc0dd\uc131 \ud568\uc218","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"PBKDF2(Password-Based Key Derivation Function 2) \uc54c\uace0\ub9ac\uc998\uc744 \uc0ac\uc6a9"}),"\n",(0,i.jsxs)(n.li,{children:["Pbkdf2Hash64()","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func Pbkdf2Hash64(data []byte) (string, error) {\r\n    salt, _ := Salt(SaltSize)\r\n    key := pbkdf2.Key([]byte(data), salt, 1000, 32, sha256.New) // 1000\uc740 \ubc18\ubcf5 \ud69f\uc218, 32\ub294 \ud0a4 \uae38\uc774, \ud574\uc2dc \ud568\uc218\ub85c SHA-256\uc744 \uc0ac\uc6a9\r\n\r\n    hash := append(key, salt...)\r\n    hash64 := base64.StdEncoding.EncodeToString(hash)\r\n\r\n    // \uad6d\uac00\uc6a9 \ubcf4\uc548\uc694\uad6c\uc0ac\ud56d V3 : \uba54\ubaa8\ub9ac \ub36e\uc5b4\uc4f0\uae30\r\n    for _, v := range []byte{0, 0, 0, 0, 0} {\r\n        for i := 0; i < len(key); i++ {\r\n            key[i] = v\r\n        }\r\n        for i := 0; i < len(salt); i++ {\r\n            salt[i] = v\r\n        }\r\n    }\r\n\r\n    return hash64, nil\r\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud574\uc2dc\uac12 \ube44\uad50 \ud568\uc218","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["ComparePbkdf2Hash64()","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func ComparePbkdf2Hash64(data []byte, hash64 string) error {\r\n    // Base64 \ub514\ucf54\ub529\r\n    hash, err := base64.StdEncoding.DecodeString(hash64)\r\n    if err != nil {\r\n        return err\r\n    }\r\n\r\n    if len(hash) != 32+SaltSize {\r\n        return fmt.Errorf("the length of hash must be 48")\r\n    }\r\n\r\n    salt := hash[len(hash)-SaltSize:]\r\n\r\n    key := pbkdf2.Key([]byte(data), salt, 1000, 32, sha256.New)\r\n    rehash := append(key, salt...)\r\n\r\n    if !bytes.Equal(hash, rehash) {\r\n        return fmt.Errorf("not equal")\r\n    }\r\n\r\n    // \uad6d\uac00\uc6a9 \ubcf4\uc548\uc694\uad6c\uc0ac\ud56d V3 : \uba54\ubaa8\ub9ac \ub36e\uc5b4\uc4f0\uae30\r\n    for _, v := range []byte{0, 0, 0, 0, 0} {\r\n        for i := 0; i < len(key); i++ {\r\n            key[i] = v\r\n        }\r\n        for i := 0; i < len(salt); i++ {\r\n            salt[i] = v\r\n        }\r\n    }\r\n\r\n    return nil\r\n}\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.h3,{id:"filego",children:"file.go"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ud574\ub2f9 \uacbd\ub85c\uc5d0 \ud30c\uc77c\uc774 \uc788\ub294\uc9c0 \ud655\uc778\ud558\ub294 \ud568\uc218","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func IsFile(path string) bool {\r\n    if st, err := os.Stat(path); err == nil {\r\n        return !st.IsDir()\r\n    }\r\n    return false\r\n}\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud574\uc2dc\uc0dd\uc131 \ud568\uc218","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func (s *FileSum) Make(file string) error {\r\n    body, err := os.ReadFile(file)\r\n    if err != nil {\r\n        return err\r\n    }\r\n    if len(body) == 0 {\r\n        return fmt.Errorf("\ud30c\uc77c\ud06c\uae30\uc5c6\uc74c")\r\n    }\r\n\r\n    pbk, err := Pbkdf2Hash(body)\r\n    if err != nil {\r\n        return err\r\n    }\r\n\r\n    sum := file + ".sum"\r\n    err = os.WriteFile(sum, pbk, 0600)\r\n    if err != nil {\r\n        return err\r\n    }\r\n\r\n    err = s.H.Make(sum)\r\n    if err != nil {\r\n        return err\r\n    }\r\n    return nil\r\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud574\uc2dc\uac80\uc0ac \ud568\uc218","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func (s *FileSum) Has(file string) error {\r\n    sum := file + ".sum"\r\n    err := s.H.Has(sum)\r\n    if err != nil {\r\n        return err\r\n    }\r\n\r\n    b, err := os.ReadFile(sum)\r\n    if err != nil {\r\n        return err\r\n    }\r\n    if len(b) <= s.H.LenHash {\r\n        return fmt.Errorf("\ud574\uc2dc\uae38\uc774\uc9e7\uc74c")\r\n    }\r\n    sumbody := b[:len(b)-s.H.LenHash]\r\n\r\n    origin, err := os.ReadFile(file)\r\n    if err != nil {\r\n        return err\r\n    }\r\n\r\n    return ComparePbkdf2Hash(origin, sumbody)\r\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.h3,{id:"errorgo",children:"error.go"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\uc544\ub798\uc640 \uac19\uc774 ErrorStack\uc744 \uc0ac\uc6a9\ud558\uc5ec \uae30\ubcf8 Error\uc5d0 \ucd94\uac00 \uc815\ubcf4\ub97c \ub354\ud568"}),"\n",(0,i.jsxs)(n.li,{children:["ErrorStack()","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func ErrorStack(err interface{}, param ...interface{}) error {\r\n    _, fn, line, _ := runtime.Caller(1)\r\n    f := path.Base(fn)\r\n    f = strings.TrimSuffix(f, ".go")\r\n\r\n    le := LineError{Timestamp: time.Now().Unix(), File: f, Line: line}\r\n    switch terr := err.(type) {\r\n    case string:\r\n        var note string\r\n        if len(param) > 0 {\r\n            note = fmt.Sprintf(terr, param...)\r\n        } else {\r\n            note = terr\r\n        }\r\n        note = strings.TrimSpace(note)\r\n\r\n        le.Err = nil\r\n        le.Note = note\r\n\r\n    case error:\r\n        var note string\r\n        if len(param) > 0 {\r\n            note = fmt.Sprintf(fmt.Sprintf("%v", param[0]), param[1:]...)\r\n        }\r\n        note = strings.TrimSpace(note)\r\n\r\n        le.Err = terr\r\n        le.Note = note\r\n\r\n    case nil:\r\n        var note string\r\n        if len(param) > 0 {\r\n            note = fmt.Sprintf(fmt.Sprintf("%v", param[0]), param[1:]...)\r\n        }\r\n        note = strings.TrimSpace(note)\r\n\r\n        le.Err = nil\r\n        le.Note = note\r\n    }\r\n\r\n    return &le\r\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\uc0ac\uc6a9\uc608","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// \ud1a0\ud070 \uc815\ucc45 \uc870\ud68c\r\ntokenPolicy, err := tokenPolicyMgr.Get(r.Context(), "admin")\r\nif err != nil {\r\n\tlogging.Errorln(err)\r\n\tw.WriteHeader(http.StatusBadRequest)\r\n\tw.Write([]byte(tool.ErrorStack(err, "E_DEFT_0000").Error()))\r\n\treturn\r\n}\r\n\r\n// {handleadminlogin:355}[E_DEFT_0001]<- error occurred\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["error.csv","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"// \ucf54\ub4dc, \uba54\uc2dc\uc9c0, \uba54\uc2dc\uc9c0\uc0c1\uc138\r\nE_DEFT_0000,\uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758 \ubc14\ub78c,\uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758 \ubc14\ub78c\r\n\r\nE_CKAU_0001,\ub85c\uadf8\uc778 \uc2e4\ud328,\uc138\uc158 \ucd5c\uc885\uc0ac\uc6a9\uc2dc\uac04 \uac31\uc2e0\uc624\ub958\r\nE_CKAU_0002,\ub85c\uadf8\uc778 \uc2e4\ud328,\uc54c\uc218\uc5c6\ub294 \uc138\uc158\ucfe0\ud0a4\r\nE_CKAU_0003,\ub85c\uadf8\uc778 \uc2e4\ud328,\ub85c\uadf8\uc778 \ud5c8\uc6a9\uc2dc\uac04 \uc624\ub958\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.h3,{id:"logginggo",children:"logging.go"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ub808\ubca8","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Fatal : \uce58\uba85\uc801 \uc5d0\ub7ec (\ub85c\uae45 \ud6c4 \ud504\ub85c\uc138\uc2a4\uac00 \uc885\ub8cc\ub428)"}),"\n",(0,i.jsx)(n.li,{children:"Error : \uc5d0\ub7ec"}),"\n",(0,i.jsx)(n.li,{children:"Normal : \uc77c\ubc18\ub85c\uadf8"}),"\n",(0,i.jsx)(n.li,{children:"Debug : \ub514\ubc84\uae45\uc6a9 \ub85c\uadf8"}),"\n",(0,i.jsx)(n.li,{children:"Verbose : \ub0ae\uc740\uc218\uc900 \ub85c\uadf8"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\uc0ac\uc6a9\uc608","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:['logging := NewLogging().SetFile("/tmp/a.log").SetConsole(true).SetLevel(true, true, true, true).SetLimit(2, 50000)',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\uba54\uc11c\ub4dc \uccb4\uc774\ub2dd\uc744 \ud1b5\ud574 \ub2e4\uc591\ud55c \ub85c\uae45 \uc124\uc815\uc744 \uc9c0\uc815"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Debugln \ud568\uc218","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// LogLevel : LogLevel \ub300\ud55c \uace0\uc720\uc774\ub984\r\ntype LogLevel int\r\n\r\n// Debugln : format\ub41c debug \ub85c\uae45\r\nfunc (l *Logging) Debugln(param ...interface{}) {\r\n    if l == nil {\r\n        return\r\n    }\r\n    if l.isDebug {\r\n        l.writeln(Debug, param...)\r\n    }\r\n}\r\n\r\nfunc (l *Logging) writeln(level LogLevel, param ...interface{}) {\r\n    _, fn, line, _ := runtime.Caller(2)\r\n    fn = strings.TrimSuffix(fn, ".go")\r\n    f := strings.Split(fn, "/")\r\n    s := fmt.Sprintln(param...)\r\n\r\n    w := fmt.Sprintf("%s [%s:%d] %s", level.String(), f[len(f)-1], line, s)\r\n    // \ucf58\uc194 \ucd9c\ub825\uc774 \uc124\uc815\ub418\uc5b4 \uc788\ub2e4\uba74, \ucf58\uc194\uc5d0\ub3c4 \ucd9c\ub825\r\n    if l.hasConsole {\r\n        log.Printf("%s", w)\r\n    }\r\n\r\n    l.send(level, w)\r\n}\r\n\r\n// send : \uac00\uc7a5 \ub0ae\uc740 \uc218\uc900\uc758 \uc4f0\uae30\ud568\uc218\uc774\ub2e4.\r\nfunc (l *Logging) send(level LogLevel, text string) {\r\n    // \ub77d\r\n    l.Mutex.Lock()\r\n    defer func() {\r\n        //Fatal \uc774\uba74 \ud504\ub85c\uc138\uc2a4\ub97c \uac15\uc81c \uc885\ub8cc\uc2dc\ud0ac \uac83\uc774\ubbc0\ub85c Unlock\ud574\uc904 \ud544\uc694\uc5c6\ub2e4.\r\n        if level == Fatal {\r\n            time.Sleep(100 * time.Millisecond)\r\n            os.Exit(1)\r\n        } else {\r\n            l.Mutex.Unlock()\r\n        }\r\n    }()\r\n\r\n    if len(l.file) > 0 {\r\n        if l.maxSize > 0 && l.curSize > l.maxSize {\r\n            l.backup()\r\n            l.archive()\r\n        }\r\n        if l.dest != nil {\r\n            l.curSize = l.curSize + 20 + int64(len(text)) + 1\r\n            l.dest.Printf(text)\r\n        }\r\n    }\r\n}\n'})}),"\n"]}),"\n"]})]})}function h(r={}){const{wrapper:n}={...(0,l.a)(),...r.components};return n?(0,i.jsx)(n,{...r,children:(0,i.jsx)(d,{...r})}):d(r)}},1151:(r,n,e)=>{e.d(n,{Z:()=>a,a:()=>s});var i=e(7294);const l={},t=i.createContext(l);function s(r){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof r?r(n):{...n,...r}}),[n,r])}function a(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(l):r.components||l:s(r.components),i.createElement(t.Provider,{value:n},r.children)}}}]);