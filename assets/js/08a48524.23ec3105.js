"use strict";(self.webpackChunkACRA_Point_V3_Education=self.webpackChunkACRA_Point_V3_Education||[]).push([[663],{2914:(n,r,e)=>{e.r(r),e.d(r,{assets:()=>d,contentTitle:()=>t,default:()=>g,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var a=e(5893),i=e(1151);const l={},t="main.go",o={type:"mdx",permalink:"/ilovedev/wauth/main",source:"@site/src/pages/wauth/main.md",title:"main.go",description:"wauth \ud504\ub85c\uadf8\ub7a8\uc758 \uc9c4\uc785\uc810(entry point) \ud30c\uc77c.",frontMatter:{},unlisted:!1},d={},s=[{value:"package\uc640 import",id:"package\uc640-import",level:3},{value:"\uc804\uc5ed\ubcc0\uc218",id:"\uc804\uc5ed\ubcc0\uc218",level:3},{value:"main \ud568\uc218",id:"main-\ud568\uc218",level:3},{value:"\ub77c\uc6b0\ud130 \ubc0f \ud578\ub4e4\ub7ec",id:"\ub77c\uc6b0\ud130-\ubc0f-\ud578\ub4e4\ub7ec",level:3},{value:"\uae30\ud0c0",id:"\uae30\ud0c0",level:3}];function c(n){const r={a:"a",code:"code",h1:"h1",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.h1,{id:"maingo",children:"main.go"}),"\n",(0,a.jsx)(r.p,{children:"wauth \ud504\ub85c\uadf8\ub7a8\uc758 \uc9c4\uc785\uc810(entry point) \ud30c\uc77c."}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(r.h3,{id:"package\uc640-import",children:"package\uc640 import"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"main.go\uc758 package \uc774\ub984\uc740 main"}),"\n",(0,a.jsxs)(r.li,{children:["import \ud0a4\uc6cc\ub4dc\ub294 \uc678\ubd80 \ud328\ud0a4\uc9c0\ub97c \ud604\uc7ac \uc18c\uc2a4 \ucf54\ub4dc\uc5d0\uc11c \uc0ac\uc6a9\ud560 \uc218 \uc788\ub3c4\ub85d \uac00\uc838\uc634","\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"import \ubb38\uc740 Go \uc18c\uc2a4 \ucf54\ub4dc \ud30c\uc77c\uc758 \ub9e8 \uc704\uc5d0 \uc704\uce58\ud558\uba70, \uc0ac\uc6a9\ud560 \ud328\ud0a4\uc9c0\ub97c \uc9c0\uc815"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["main.go \uc18c\uc2a4","\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n        "context"   // \ub0b4\uc7a5 \ub77c\uc774\ube0c\ub7ec\ub9ac\r\n        "fmt"\r\n        "math/rand"\r\n        "net/http"\r\n        "runtime"\r\n        "time"\r\n\r\n        "github.com/acrav3/libconfigkey"            // \ubd84\ub9ac\ub41c \ud328\ud0a4\uc9c0 libconfigkey\r\n        "github.com/acrav3/liblicense"\r\n        "github.com/acrav3/wauth/admininboxmanager" // wauth \ub0b4\ubd80\uc5d0 \uc874\uc7ac\ud558\ub294 \ud328\ud0a4\uc9c0 admininboxmanager\r\n        "github.com/acrav3/wauth/adminmanager"\r\n        // ...\r\n\r\n        "github.com/gorilla/handlers"               // wauth\uc5d0\uc11c \uc0ac\uc6a9\ub418\ub294 http \uad00\ub828 \ub77c\uc774\ube0c\ub7ec\ub9ac\r\n        "github.com/gorilla/mux"\r\n)\n'})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(r.h3,{id:"\uc804\uc5ed\ubcc0\uc218",children:"\uc804\uc5ed\ubcc0\uc218"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"main.go\uc758 \uc804\uc5ed\ubcc0\uc218"}),"\n",(0,a.jsxs)(r.li,{children:["\ub2e4\ub978 \ud30c\uc77c(handler\uc5d0\uc11c \uc0ac\uc6a9)","\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-go",children:"var (\r\n    keyMgr  *libconfigkey.KeyManager\r\n    nodeMgr *nodemanager.NodeManager\r\n\r\n    adminMgr                *adminmanager.AdminManager\r\n    userMgr                 *usermanager.UserManager\r\n    // ...\r\n)\n"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(r.h3,{id:"main-\ud568\uc218",children:"main \ud568\uc218"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["wauth\uc758 main \ud568\uc218","\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-go",children:'func main() {\r\n    runtime.GOMAXPROCS(runtime.NumCPU()) // \ud604\uc7ac CPU \uc218\ub9cc\ud07c \uace0\ub8e8\ud2f4\uc758 \ub3d9\uc2dc \uc2e4\ud589 \uc218\ub97c \uc124\uc815(Go \uc5b8\uc5b4\uc5d0\uc11c \ubcd1\ub82c \ud504\ub85c\uadf8\ub798\ubc0d\uc744 \uc704\ud574 \uc0ac\uc6a9\ub418\ub294 \ucf54\ub4dc)\r\n\r\n    var err error\r\n\r\n    ctx, cancel := context.WithTimeout(context.Background(), 15*time.Second)\r\n    defer cancel()\r\n\r\n    logging.Debugln("wresource start")\r\n\r\n    defer client.Close()\r\n\r\n    // manager \uc120\uc5b8\r\n    // {\ub9e4\ub2c8\uc800 \uc774\ub984}, {\uc624\ub958\uac1d\uccb4} = {\ub77c\uc774\ube0c\ub7ec\ub9ac\uc774\ub984}.New({context}, {\ub85c\uae45\uc778\uc2a4\ud134\uc2a4}, ..., {mongodb client \ud3ec\uc778\ud130})\r\n    keyMgr, err = libconfigkey.New(ctx, logging, flagConfdir, client)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    AESKey, err = keyMgr.GetAESKey(ctx)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    JWTKey, err = keyMgr.GetJWTKey(ctx)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    HashKey, err = keyMgr.GetHashKey(ctx)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    errorMgr, err = errormanager.New(ctx, logging, client)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    rsaKeyMgr, err = rsakeymanager.New(ctx, logging, client, AESKey)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    adminMgr, err = adminmanager.New(ctx, logging, client, AESKey)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n    userMgr, err = usermanager.New(ctx, logging, client, AESKey)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n\r\n    // ...\r\n\r\n    licenseMgr, err = liblicense.NewLicenseManager(ctx, logging, client, AESKey)\r\n    if err != nil {\r\n        logging.Fatalln(err)\r\n    }\r\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(r.h3,{id:"\ub77c\uc6b0\ud130-\ubc0f-\ud578\ub4e4\ub7ec",children:"\ub77c\uc6b0\ud130 \ubc0f \ud578\ub4e4\ub7ec"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"wauth\uc758 \ub77c\uc6b0\ud130 \ubc0f \ud578\ub4e4\ub7ec"}),"\n",(0,a.jsxs)(r.li,{children:["\uae30\ubcf8\uc801\uc73c\ub85c gorilla\ub97c \uc0ac\uc6a9","\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"Gorilla is a web toolkit for the Go programming language that provides useful, composable packages for writing HTTP-based applications."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\uae30\ubcf8 \uc608\uc81c","\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-go",children:'func main() {\r\n    r := mux.NewRouter()\r\n    r.HandleFunc("/", HomeHandler)\r\n    r.HandleFunc("/products", ProductsHandler)\r\n    r.HandleFunc("/articles", ArticlesHandler)\r\n    http.Handle("/", r)\r\n}\n'})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\uc0c1\uc138\ub0b4\uc6a9","\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"https://github.com/gorilla/mux",children:"https://github.com/gorilla/mux"})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\uc18c\uc2a4","\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-go",children:'// \ub77c\uc6b0\ud130 \ubc0f \ud578\ub4e4\ub7ec \uc124\uc815\r\nr := mux.NewRouter().PathPrefix(Config.ServiceBaseURI).Subrouter()\r\n// mux.NewRouter().PathPrefix("/").Subrouter()\r\n\r\n// Login / Logout\r\nr.Path("/api/adminlogin").Methods("POST").HandlerFunc(HandlerAdminLogin)\r\n// r.Path({Handle\ud560 url\uc8fc\uc18c}).Methods("POST").HandlerFunc({Handle\uc774\ub984-\ud568\uc218\uc774\ub984})\r\n\r\nr.Path("/api/adminlogout").Methods("POST").HandlerFunc(HandlerAdminLogout)\r\nr.Path("/api/self/userlogin").Methods("POST").HandlerFunc(HandlerUserLogin)\r\nr.Path("/api/self/userlogout").Methods("POST").HandlerFunc(HandlerUserLogout)\r\n\r\nr.Path("/api/valid").Methods("GET").HandlerFunc(HandlerValid)\r\n\r\n// rsapublickey\r\nr.Path("/api/rsapublickey:create").Methods("POST").HandlerFunc(HandlerCreateRSAKey)\r\nr.Path("/api/free/rsapublickey:create").Methods("POST").HandlerFunc(HandlerCreateRSAKey)\r\n\r\n// ...\r\n\r\n// Admins\r\nr.Path("/api/admins").Methods("GET").HandlerFunc(HandlerListAdmins)\r\nr.Path("/api/admins/{id}").Methods("GET").HandlerFunc(HandlerGetAdmin)\r\nr.Path("/api/admins:create").Methods("POST").HandlerFunc(HandlerCreateAdmin)\r\nr.Path("/api/admins:update").Methods("POST").HandlerFunc(HandlerUpdateAdmin)\r\nr.Path("/api/admins:delete").Methods("POST").HandlerFunc(HandlerDeleteAdmin)\r\nr.Path("/api/admins:lock").Methods("POST").HandlerFunc(HandlerLockAdmin)\r\nr.Path("/api/admins:unlock").Methods("POST").HandlerFunc(HandlerUnlockAdmin)\r\n\r\n// ...\r\n\r\nr.Use(Middleware)   // \ubbf8\ub4e4\uc6e8\uc5b4 \uc0ac\uc6a9\r\nlogging.Normalln("http.Listening ready")\r\n\r\n// CORS \ucc98\ub9ac\r\nheader := handlers.AllowedHeaders([]string{"X-Requested-With", "Content-Type", "Authorization"})    // \ud5c8\uc6a9\ub41c HTTP \ud5e4\ub354\ub97c \uc124\uc815\r\nmethods := handlers.AllowedMethods([]string{"GET", "POST", "PUT", "HEAD", "OPTIONS"})               // \ud5c8\uc6a9\ub41c HTTP \uba54\uc11c\ub4dc\ub97c \uc124\uc815\r\norigins := handlers.AllowedOrigins([]string{"http://localhost:3000"})                               // \ud5c8\uc6a9\ub41c \ucd9c\ucc98(Origin)\ub97c \uc124\uc815\r\ncredentials := handlers.AllowCredentials()      // \uc790\uaca9 \uc99d\uba85\uc744 \uc694\uccad \ubc0f \uc751\ub2f5\uc5d0 \ud3ec\ud568\ud560 \uc218 \uc788\ub3c4\ub85d \ud5c8\uc6a9\r\n\r\n//  HTTP \uc11c\ubc84\ub97c \uc2dc\uc791\ud558\ub294 \ud568\uc218 (\uc704\uc5d0\uc11c \uc124\uc815\ub41c \ub77c\uc6b0\ud130 r\ub85c \ub77c\uc6b0\ud305\ud568)\r\nerr = http.ListenAndServe(fmt.Sprintf("%s:%d", Config.ServiceIP, Config.ServicePort), handlers.CORS(header, methods, origins, credentials)(r))\r\nif err != nil {\r\n\tlogging.Fatalln(err)\r\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(r.h3,{id:"\uae30\ud0c0",children:"\uae30\ud0c0"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["\ubc30\uce58(\uc4f0\ub808\ub4dc) \uad00\ub828 \uc18c\uc2a4 (\uace0\ub8e8\ud2f4)","\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-go",children:"// \ub85c\uc9c1: \ub79c\ub364 \uc2dc\uac04\uc5d0 \ub77c\uc774\uc120\uc2a4 \ud3c9\uac00\r\ngo Thread_LicenseCheck()\r\n\r\n// \uc8fc\uae30\uc801\uc73c\ub85c \ub9cc\ub8cc\ub41c \uc0ac\uc6a9\uc790 \uc624\ud504\ub77c\uc778\ud1a0\ud070\uc744 \uc0ad\uc81c\ud569\ub2c8\ub2e4.\r\ngo adminMgr.Thread_CheckOfflineToken()\r\n// \uc8fc\uae30\uc801\uc73c\ub85c \uad00\ub9ac\uc790 \ub85c\uadf8\uc778 \uc2dc\ub3c4 \ud69f\uc218\ub97c \ucd08\uae30\ud654 \ud569\ub2c8\ub2e4.\r\ngo adminMgr.Thread_CheckNumLogonAttempt()\r\n\r\n// \uc8fc\uae30\uc801\uc73c\ub85c \ub9cc\ub8cc\ub41c \uc0ac\uc6a9\uc790 \uc624\ud504\ub77c\uc778\ud1a0\ud070\uc744 \uc0ad\uc81c\ud569\ub2c8\ub2e4.\r\ngo userMgr.Thread_CheckOfflineToken()\r\n// \uc8fc\uae30\uc801\uc73c\ub85c \ub9cc\ub8cc\ub41c \uc0ac\uc6a9\uc790 \uc5b4\ud50c\ub9ac\ucf00\uc774\uc158\ud1a0\ud070\uc744 \uc0ad\uc81c\ud569\ub2c8\ub2e4.\r\ngo userMgr.Thread_CheckApplicationToken()\r\n// \uc8fc\uae30\uc801\uc73c\ub85c \uc0ac\uc6a9\uc790 \ub85c\uadf8\uc778 \uc2dc\ub3c4 \ud69f\uc218\ub97c \ucd08\uae30\ud654 \ud569\ub2c8\ub2e4.\r\ngo userMgr.Thread_CheckNumLogonAttempt()\r\n\r\n// \ub85c\uc9c1: \uad00\ub9ac\uc790 \uc138\uc158 \uc815\ub9ac\r\ngo adminWebSessionMgr.Thread_AdminWebSession()\r\n// \ub85c\uc9c1: \uc0ac\uc6a9\uc790 \uc138\uc158 \uc815\ub9ac\r\ngo userWebSessionMgr.Thread_UserWebSession()\n"})}),"\n"]}),"\n"]})]})}function g(n={}){const{wrapper:r}={...(0,i.a)(),...n.components};return r?(0,a.jsx)(r,{...n,children:(0,a.jsx)(c,{...n})}):c(n)}},1151:(n,r,e)=>{e.d(r,{Z:()=>o,a:()=>t});var a=e(7294);const i={},l=a.createContext(i);function t(n){const r=a.useContext(l);return a.useMemo((function(){return"function"==typeof n?n(r):{...r,...n}}),[r,n])}function o(n){let r;return r=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:t(n.components),a.createElement(l.Provider,{value:r},n.children)}}}]);